import { useContext, useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import Header from '../components/Layout/Header';
import Footer from '../components/Layout/Footer';
import FileUploader from '../components/Dashboard/FileUploader';
import FileList from '../components/Dashboard/FileList';
import StorageMeter from '../components/Dashboard/StorageMeter';
import PackageSelector from '../components/Dashboard/PackageSelector';
import { UserContext } from '../context/UserContext';

export default function Dashboard() {
  const router = useRouter();
    const { user, setUser } = useContext(UserContext);
      const [files, setFiles] = useState([]);
        const [storageUsed, setStorageUsed] = useState(0);
          const [storageLimit, setStorageLimit] = useState(1073741824); // 1GB بشكل افتراضي
            const [showUpgrade, setShowUpgrade] = useState(false);

              useEffect(() => {
                  if (!user) {
                        router.push('/');
                              return;
                                  }
                                      
                                          // جلب ملفات المستخدم
                                              const fetchFiles = async () => {
                                                    // في التطبيق الحقيقي، سيتم جلب البيانات من الخدمة
                                                          const userFiles = await getUserFiles(user.id);
                                                                setFiles(userFiles);
                                                                      
                                                                            // حساب المساحة المستخدمة
                                                                                  const used = userFiles.reduce((total, file) => total + file.size, 0);
                                                                                        setStorageUsed(used);
                                                                                              
                                                                                                    // التحقق إذا كان المستخدم بحاجة لترقية
                                                                                                          if (used / storageLimit > 0.8) {
                                                                                                                  setShowUpgrade(true);
                                                                                                                        }
                                                                                                                            };
                                                                                                                                
                                                                                                                                    fetchFiles();
                                                                                                                                      }, [user, storageLimit]);

                                                                                                                                        const handleUploadSuccess = (fileInfo) => {
                                                                                                                                            setFiles([...files, fileInfo]);
                                                                                                                                                setStorageUsed(storageUsed + fileInfo.size);
                                                                                                                                                    
                                                                                                                                                        // التحقق من الحد المسموح بعد الرفع
                                                                                                                                                            if ((storageUsed + fileInfo.size) / storageLimit > 0.8) {
                                                                                                                                                                  setShowUpgrade(true);
                                                                                                                                                                      }
                                                                                                                                                                        };

                                                                                                                                                                          const handlePackageSelect = (packageSize) => {
                                                                                                                                                                              // تحديث حد التخزين بناءً على الباقة المختارة
                                                                                                                                                                                  switch (packageSize) {
                                                                                                                                                                                        case '100GB':
                                                                                                                                                                                                setStorageLimit(100 * 1024 * 1024 * 1024); // 100GB
                                                                                                                                                                                                        break;
                                                                                                                                                                                                              case '1TB':
                                                                                                                                                                                                                      setStorageLimit(1024 * 1024 * 1024 * 1024); // 1TB
                                                                                                                                                                                                                              break;
                                                                                                                                                                                                                                    case '5TB':
                                                                                                                                                                                                                                            setStorageLimit(5 * 1024 * 1024 * 1024 * 1024); // 5TB
                                                                                                                                                                                                                                                    break;
                                                                                                                                                                                                                                                          default:
                                                                                                                                                                                                                                                                  setStorageLimit(1024 * 1024 * 1024); // 1GB
                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              setShowUpgrade(false);
                                                                                                                                                                                                                                                                                  // في التطبيق الحقيقي، سيتم هنا توجيه المستخدم لصفحة الدفع
                                                                                                                                                                                                                                                                                      router.push('/payment');
                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                          return (
                                                                                                                                                                                                                                                                                              <div className="min-h-screen flex flex-col bg-gray-50">
                                                                                                                                                                                                                                                                                                    <Header />
                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                <main className="flex-grow container mx-auto px-4 py-6">
                                                                                                                                                                                                                                                                                                                        <div className="mb-6">
                                                                                                                                                                                                                                                                                                                                  <h1 className="text-2xl font-bold text-indigo-700">لوحة تحكم CloudWeb3</h1>
                                                                                                                                                                                                                                                                                                                                            <p className="text-gray-600">مرحباً بك، {user?.name}</p>
                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                    {showUpgrade && (
                                                                                                                                                                                                                                                                                                                                                                              <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                                                                                                                                                                                                                                                                                                                                                                          <div className="flex">
                                                                                                                                                                                                                                                                                                                                                                                                        <div className="ml-3">
                                                                                                                                                                                                                                                                                                                                                                                                                        <p className="text-sm text-yellow-700">
                                                                                                                                                                                                                                                                                                                                                                                                                                          لقد استخدمت أكثر من 80% من مساحتك التخزينية. 
                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onClick={() => setShowUpgrade(true)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="ml-1 font-medium text-indigo-600 hover:text-indigo-500"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          قم بترقية باقة التخزين الخاصة بك الآن.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="lg:col-span-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div className="bg-white rounded-lg shadow p-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h2 className="text-xl font-semibold mb-4">رفع ملف جديد</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <FileUploader 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          onUploadSuccess={handleUploadSuccess} 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          storageLimit={storageLimit}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          storageUsed={storageUsed}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="bg-white rounded-lg shadow p-6 mt-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <h2 className="text-xl font-semibold mb-4">ملفاتك</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <FileList files={files} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="lg:col-span-1">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div className="bg-white rounded-lg shadow p-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h2 className="text-xl font-semibold mb-4">مساحتك التخزينية</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <StorageMeter used={storageUsed} total={storageLimit} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="mt-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <h3 className="font-medium mb-2">ترقية الباقة</h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <PackageSelector onSelect={handlePackageSelect} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="mt-8">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <h3 className="font-medium mb-2">تحويل إلى Web3</h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p className="text-sm text-gray-600 mb-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  قم بتحويل حسابك إلى حساب Web3 لامركزي للوصول إلى ملفاتك من أي مكان في العالم.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onClick={() => router.push('/web3-convert')}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      className="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        التحويل إلى Web3 ($5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="bg-white rounded-lg shadow p-6 mt-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <h2 className="text-xl font-semibold mb-4">الدعم والمساعدة</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <p className="text-gray-600 mb-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      نحن هنا لمساعدتك في أي وقت. تواصل معنا عبر:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <ul className="space-y-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <li className="flex items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span className="text-indigo-600 mr-2">واتساب:</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span>+1234567890</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <li className="flex items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span className="text-indigo-600 mr-2">لينكد إن:</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <a href="#" className="text-blue-500 hover:underline">CloudWeb3</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <li className="flex items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span className="text-indigo-600 mr-2">الإيميل:</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <a href="mailto:support@cloudweb3.oneworld" className="text-blue-500 hover:underline">support@cloudweb3.oneworld</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </ul>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </main>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <Footer />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }